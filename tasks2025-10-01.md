# Visdom taskplan 2025-10-01

## Uppgift: Lärarkontroller i Kurseditorn (feature/teacher-controls-v1)
- **Del 1 – Databas & Storage**: skapa migrations för public-media/course-media buckets, RLS, funktioner `public.user_is_teacher`, `public.course_id_from_path`, `public.user_has_course_access`, samt kolumnen `storage_bucket` i `app.lesson_media`.
- **Del 2 – Repository-lager**: uppdatera StudioRepository och CoursesRepository för direktuppladdning via `uploadBinary`, hantera buckets, positionsordning, borttagning och `hasAccess`.
- **Del 3 – Kurseditor-UI**: metadata-panel (titel, slug, pris, intro, publicering), mediaflöde med intro/betal-växlar, uppladdningar, sortering och borttagning, samt flikar för lärar-/elevvy.
- **Del 4 – Router/Access**: säkerställ teacher-guard för studio, tillämpa betalt åtkomstskydd i course player.
- **Del 5 – Test & kvalitet**: widgettest för kurseditor, repository-test för uppladdning, access-test för kursåtkomst, kör format/analyze/test.
- **Del 6 – Leverabler**: migrations, uppdaterade repositories, uppdaterad UI, README-notis, dokumenterade testinstruktioner.

## Status
- [x] Del 1 – Klart (migreringar körda i Supabase)
- [x] Del 2 – Repositories uppdaterade för nya buckets
- [x] Del 3 – Kurseditor (klar: metadata, mediaflöde, elevförhandsgranskning)
- [x] Del 4 – Router/access
- [x] Del 5 – Tester
- [x] Del 6 – Leverabler

## Kommentarer
- 2025-10-01: Körde migreringarna `2025-09-30_storage_paid_media.sql` & `2025-09-30_lesson_media_bucket.sql` i Supabase.
- 2025-10-01: Uppdaterade StudioRepository/CoursesRepository + kurseditor för ny metadata-panel och bucket-hantering.
- 2025-10-01: Kurseditor-UI ombyggd med modul/lektionshantering, intro-växlar, uppladdning och sortering av media.
- 2025-10-01: Introducerade LessonMediaPathBuilder + CourseAccessApi för testbarhet samt nya enhets-/widgettester (kör `flutter test` lokalt).
- 2025-10-01: Testerna passerar lokalt efter refaktorerad access-fallback och uppdaterad widgetstub.
- 2025-10-01: Lade till förhandsgranskning (Lärare/Elev utan köp/Elev med köp) i kurseditorn.
- 2025-10-01: Kurslektioner laddar nu media från buckets (`public-media`/`course-media`) med offline-nedladdning.
- 2025-10-01: Router uppdaterad – `/teacher` och `/teacher/editor` kräver nu teacher/admin-roll.
- 2025-10-01: Leverabler dokumenterade i `docs/teacher_controls_v1_deliverables.md` + README-notis och testinstruktioner uppdaterade.

## Del 6 – Leverabler
- Migrations: `supabase/migrations/2025-09-30_storage_paid_media.sql`, `supabase/migrations/2025-09-30_lesson_media_bucket.sql`.
- Repositories: `lib/features/studio/data/studio_repository.dart`, `lib/features/studio/data/lesson_media_path.dart`, `lib/features/courses/data/course_access_api.dart`, `lib/features/courses/data/courses_repository.dart`.
- UI: `lib/features/studio/presentation/course_editor_page.dart`, `lib/features/courses/presentation/course_access_gate.dart`, `lib/features/payments/presentation/paywall_prompt.dart`.
- Dokumentation: README-avsnitt "Teacher Controls v1" + `docs/teacher_controls_v1_deliverables.md`.
- Tester: `test/widgets/course_editor_screen_test.dart`, `test/unit/courses_repository_access_test.dart`, `test/unit/lesson_media_path_builder_test.dart` (kör med `flutter test …`).

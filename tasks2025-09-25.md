# Visdom taskplan 2025-09-25

## Nuläge
- Social feed, kursstudio, certifikatflöde och Supabase-integration aktiva enligt senaste projektöversikten (summary2025-09-25:1).
- Kodbas blandar äldre andlig_app-moduler och nya features-strukturer vilket skapar arkitektur- och importskuld (summary2025-09-25:181).
- RLS och RPC finns för flera sociala funktioner men fri nivå, rich text och stripe-flöde är delvis påbörjade (summary2025-09-25:161).
- CI, automatiska tester och Android-releaseprocess saknas eller är ofullständiga (summary2025-09-25:199).

## Gap mot blueprint `new _functions.md`
- Supabase-schema behöver konsolideras till den nya kärnstrukturen med roller, kurser, events och purchases (new _functions.md:14) utan att påverka befintlig data.
- Edge functions för Stripe finns i repo men kräver justeringar för e-postbaserade gäster, claim-tokens och metadata enligt nytt flöde (new _functions.md:379).
- Appen saknar Riverpod-baserade rollproviders, paywall-komponenter och access guards som definieras i blueprinten (new _functions.md:383).
- Paywall och course access behöver kopplas till UI-flöden samt event-skapande för professionals/teachers (new _functions.md:719).
- Storage-buckets och seed-strategi behöver kompletteras med dokumenterad åtkomstmodell (new _functions.md:774).

## Leveransvågor
### Vågs 1 – Foundation (v1)
- Konsolidera Supabase-schema, RLS och RPC till blueprinten.
- Säkerställ bucket-konfiguration och seed-skript.
- Dokumentera miljövariabler och säker hantering av service-role.

### Vågs 2 – Appintegration (v2)
- Implementera Riverpod-rollproviders, course access gate och paywall.
- Uppdatera router guards samt claim-flödet.
- Introducera eventsflöde och UI-justeringar för roller.

### Vågs 3 – Polish & Release (v3)
- Utöka testsvit och sätt upp CI/CD-workflows.
- Genomför Android release readiness och deeplink-stöd.
- Genomför UI-polish, retro-feedback och roadmap-uppdatering.

## Risker & antaganden
- Antagande: befintliga Stripe-nycklar kan återanvändas; risk om metadata/claim kräver nya dashboard-inställningar.
- Antagande: nuvarande databasmigreringar är idempotenta; risk för datalåsningar vid schemaomläggning.
- Risk för dubbelimplementation av Stripe-funktioner om gamla flows inte avvecklas ordnat.
- Risk för UI-regressioner när äldre screens ersätts innan tester och designreview är klara.

## Retro & förbättringar (uppdateras efter varje våg)
- Våg 1 retro: _TODO_
- Våg 2 retro: _TODO_
- Våg 3 retro: _TODO_

## Arbetsströmmar
### Databas & Storage
- Kartlägg nuvarande migrations och jämför med init_all-planen; bryt ut nya migrationer och testkör via Supabase CLI.
- Implementera RLS/RPC enligt blueprinten och dokumentera kontrollpunkter för varje tabell.
- Konfigurera `public_media` och `protected_media` med rätt policies och rutiner för signed URLs.
- 2025-09-25: Phase A-rollplan dokumenterad i `docs/phase_a_roles_plan.md` och migrationsutkast `supabase/2025-09-PhaseA_roles.sql` skapad.
- 2025-09-25: Phase A-migration körd i Supabase; förbered uppföljningssteg (function uppdateringar, teacher_requests → certificates).
- 2025-09-25: Utkast `supabase/2025-09-PhaseA_teacher_requests.sql` skapat för att migrera ansökningar till certifikatstrukturen.
- 2025-09-25: Migration körd; verifiera utfallet och planera avveckling av `teacher_requests` som primär läskälla.
- 2025-09-25: Uppdaterade `app.is_admin()/app.is_teacher()/app.current_role()` i `supabase/fix_app_is_teacher_recursion.sql` för att läsa `role_v2` och `is_admin`.
- 2025-09-25: `supabase/migrate_public_to_app.sql` uppdaterad för att fylla `role_v2`/`is_admin` och mappa legacy `role`.

### Edge Functions & Stripe
- Synka `stripe_checkout` mot metadata och e-postkrav, introducera claim-token-hantering i webhooken.
- Säkra miljövariabler, secret-rotation och loggning; upprätta testplan med CLI och webhook replay.
- Checklistan "Go-live Stripe" hålls uppdaterad med valideringar och fallback.

### Appintegration
- Införa Riverpod-baserade providers för session, profil och roller; refaktorera router-guards till blueprint-strukturen.
- Implementera CourseAccessGate, PaywallPrompt och HTTP-helper samt knyta dem till kursdetaljer.
- Planera och bygga claim-länksflödet inklusive magic link-sekvens och UI-feedback.
- 2025-09-25: Planerade klientuppdateringar dokumenterade i `docs/phase_a_flutter_updates.md` (Profile-modell, guards, UI).
- 2025-09-25: Genomförde första klientrefaktorn – `Profile`-modell, `AuthService`, router och booking/studio använder `role_v2`/`is_admin`.
- 2025-09-25: UI för ansökan/admin läser nu `certificates`/`teacher_approvals` i stället för `teacher_requests`.

### UI & Upplevelse
- Align landing/home/pro/teacher-flöden med blueprintens rutnät och säkerställ konsekvent copy/snackbar-hantering.
- Kombinera UI-polish och arkitekturstädning (const, imports, modulstruktur) med designreviews per iteration.
- Schemalägg interna demos/användartester och logga åtgärder i förbättringsblocket.

### Kvalitet & Release
- Etablera minsta testsuite (widget/router/data) och utöka med Stripe/claim-integrationer.
- Skapa CI/CD-workflows för format, analyze, test och Android-bygge med artefakter.
- Genomför Android-releaseuppgifter inklusive deeplinks och dokumentera rollback/monitorering.

### Uppföljning & Rapportering
- Logga status och avvikelser i `workflow2025-09-25` efter varje sessions arbete.
- Uppdatera roadmap och README när respektive våg levereras.
- Samla feedback från partners/användare och mata in i nästa planeringscykel.
